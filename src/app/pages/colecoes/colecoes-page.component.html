<div class="collections-page">
  <!-- HEADER -->
  <header class="collections-header">
    <div class="collections-header-left">
      <h1>Minhas Coleções</h1>
      <p>Gerencie todas as suas coleções de links em um só lugar.</p>
    </div>

    <button class="btn-primary" (click)="openCreateModal()">
      + Nova Coleção
    </button>
  </header>

  <!-- RESUMO -->
  <section class="collections-summary">
    <div class="summary-card">
      <span class="summary-label">Total de Coleções</span>
      <span class="summary-value">{{ collections.length }}</span>
    </div>
  </section>

  <!-- LISTA -->
  <div *ngIf="loading" class="loading">Carregando coleções...</div>

  <section class="collections-list" *ngIf="!loading && collections.length; else emptyState">
    <article class="collection-card" *ngFor="let c of collections">
      <!-- TOPO GRADIENTE (clique abre modal de links) -->
      <div class="card-header-gradient" (click)="openCollectionLinks(c)">
        <div class="card-header-content">
          <div class="collection-name">{{ c.name }}</div>
          <div class="collection-visibility">
            {{ c.visibility | titlecase }}
          </div>
        </div>
      </div>

      <!-- CORPO (também clicável pra ver links) -->
      <div class="card-body" (click)="openCollectionLinks(c)">
        <p class="collection-description">
          {{ c.description || 'Sem descrição definida.' }}
        </p>
      </div>

      <!-- RODAPÉ -->
      <div class="card-footer">
        <div class="card-footer-info">
          <span class="links-count">{{ linksInCollection(c) }} links</span>
        </div>

        <div class="card-footer-actions">
          <button
            class="icon-button"
            type="button"
            (click)="openEditModal(c); $event.stopPropagation()"
          >
            Editar
          </button>
          <button
            class="icon-button danger"
            type="button"
            (click)="deleteCollection(c); $event.stopPropagation()"
          >
            Excluir
          </button>
        </div>
      </div>
    </article>

    <!-- CARD "CRIAR NOVA COLEÇÃO" -->
    <article class="collection-card new-card">
      <button class="new-card-button" (click)="openCreateModal()">
        <span class="new-card-plus">+</span>
        <span>Criar nova coleção</span>
      </button>
    </article>
  </section>

  <!-- ESTADO VAZIO -->
  <ng-template #emptyState>
    <p class="empty-state">
      Nenhuma coleção encontrada. Clique em “Nova Coleção” para adicionar uma.
    </p>
  </ng-template>

  <!-- MODAL: CRIAR / EDITAR COLEÇÃO -->
  <div class="modal-backdrop" *ngIf="isModalOpen">
    <div class="modal">
      <div class="modal-header">
        <h2>{{ editingCollection ? 'Editar Coleção' : 'Nova Coleção' }}</h2>
        <button class="modal-close" type="button" (click)="closeModal()">✕</button>
      </div>

      <form [formGroup]="collectionForm" (ngSubmit)="saveCollection()">
        <label>
          Nome
          <input type="text" formControlName="name" />
        </label>

        <label>
          Descrição
          <textarea rows="3" formControlName="description"></textarea>
        </label>

        <label>
          Visibilidade
          <select formControlName="visibility">
            <option value="publico">Público</option>
            <option value="restrito">Restrito</option>
            <option value="privado">Privado</option>
          </select>
        </label>

        <!-- SELEÇÃO DE LINKS DA COLEÇÃO -->
        <div class="links-selector" *ngIf="links.length">
          <div class="links-selector-title">Links desta coleção</div>
          <div class="links-selector-list">
            <label *ngFor="let link of links">
              <input
                type="checkbox"
                [checked]="isLinkSelected(link)"
                (change)="toggleLinkSelection(link, $event)"
              />
              <div class="links-selector-item">
                <div class="links-selector-title-text">
                  {{ link.title || 'Sem título' }}
                </div>
                <div class="links-selector-url">
                  {{ link.short_url || link.url }}
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" (click)="closeModal()">Cancelar</button>
          <button type="submit" [disabled]="collectionForm.invalid || saving">
            {{ saving ? 'Salvando...' : 'Salvar' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: LINKS DA COLEÇÃO -->
  <div class="modal-backdrop" *ngIf="showLinksModal">
    <div class="modal modal-links">
      <div class="modal-header">
        <h2>
          Links da coleção
          <span *ngIf="currentCollection"> - {{ currentCollection.name }}</span>
        </h2>
        <button
          class="modal-close"
          type="button"
          (click)="closeCollectionLinksModal()"
        >
          ✕
        </button>
      </div>

      <div *ngIf="!currentCollectionLinks.length" class="empty-links">
        Nenhum link nesta coleção.
      </div>

      <div class="collection-links-list" *ngIf="currentCollectionLinks.length">
        <div class="collection-link-row" *ngFor="let link of currentCollectionLinks">
          <div class="collection-link-info">
            <div class="collection-link-title">
              {{ link.title || 'Sem título' }}
            </div>
            <div class="collection-link-url">
              {{ link.short_url || link.url }}
            </div>
          </div>
          <div class="collection-link-actions">
            <button type="button" (click)="copyShortUrl(link)">Copiar</button>
            <button type="button" class="danger" (click)="deleteLinkFromCollection(link)">
              Excluir
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer modal-links-footer">
        <button type="button" (click)="closeCollectionLinksModal()">Fechar</button>
      </div>
    </div>
  </div>
</div>
